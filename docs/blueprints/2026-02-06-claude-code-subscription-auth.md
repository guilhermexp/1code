# Blueprint: Claude Code Subscription Authentication Integration

> Generated by CloneSkill | Source: 1code (21st Agents Desktop App) | Date: 2026-02-06
> Scope: Full OAuth authentication flow for Claude Code subscription, token management, credential storage, and SDK invocation

## 1. Overview

- **What**: A multi-layered authentication system that connects a desktop Electron app to Anthropic's Claude Code subscription via a sandbox-proxied OAuth flow.
- **Problem it solves**: Users with Claude Pro/Max subscriptions need to securely authenticate and use their subscription quota inside a third-party desktop app, without the app ever seeing their Anthropic password.
- **Key behaviors**: Sandbox-based OAuth proxy, OS-level encrypted credential storage, multi-account support, automatic token injection into Claude SDK environment, optional import of existing CLI tokens from OS keychain.

---

## 2. Architecture

### Pattern: Sandbox-Proxied OAuth with Encrypted Local Storage

The app does NOT directly perform OAuth with Anthropic. Instead:

1. The **21st.dev backend** creates a **CodeSandbox instance** running Claude Code CLI auth
2. The sandbox generates an **Anthropic OAuth URL**
3. The user authorizes in their browser
4. The user pastes the **auth code** back into the desktop app
5. The desktop app submits the code to the sandbox, which exchanges it for a **token**
6. The token is **encrypted with OS keychain** (safeStorage) and stored in SQLite

```
┌─────────────────────────────────────────────────────────────┐
│                    DESKTOP APP (Electron)                     │
│                                                               │
│  ┌──────────┐    tRPC     ┌─────────────┐                    │
│  │ Renderer │ ◄────────► │ Main Process │                    │
│  │ (React)  │            │  (Node.js)   │                    │
│  │          │            │              │                    │
│  │ Onboard- │            │ claude-code  │                    │
│  │ ing Page │            │   router     │                    │
│  └──────────┘            └──────┬───────┘                    │
│                                  │                            │
│                    ┌─────────────┼──────────────┐            │
│                    │             │              │            │
│              ┌─────▼─────┐ ┌────▼────┐ ┌───────▼──────┐    │
│              │ AuthStore  │ │ SQLite  │ │ safeStorage  │    │
│              │ (file)     │ │ (DB)    │ │ (OS Keychain)│    │
│              │ 21st.dev   │ │ Claude  │ │              │    │
│              │ tokens     │ │ tokens  │ │              │    │
│              └────────────┘ └─────────┘ └──────────────┘    │
└──────────────────────────────────────────────────────────────┘
          │                        │
          │ HTTP                   │ HTTP
          ▼                        ▼
┌──────────────────┐     ┌─────────────────────┐
│  21st.dev API    │     │ CodeSandbox          │
│                  │     │ (claude auth proxy)  │
│ POST /api/auth/  │     │                      │
│ claude-code/start│────►│ /api/auth/:id/status │
│                  │     │ /api/auth/:id/code   │
└──────────────────┘     └──────────┬────────────┘
                                    │
                                    │ OAuth
                                    ▼
                          ┌──────────────────┐
                          │ Anthropic OAuth   │
                          │ console.anthropic │
                          │ .com/oauth        │
                          └──────────────────┘
```

### Directory Structure

```
src/
├── main/
│   ├── auth-manager.ts              # 21st.dev desktop OAuth manager (singleton)
│   ├── auth-store.ts                # Encrypted file-based storage for desktop tokens
│   ├── constants.ts                 # AUTH_SERVER_PORT, dev mode detection
│   ├── index.ts                     # App entry, deep link handling, auth callback
│   └── lib/
│       ├── claude/
│       │   ├── env.ts               # Shell environment builder, token injection
│       │   ├── index.ts             # Re-exports
│       │   └── offline-handler.ts   # Ollama fallback when offline
│       ├── claude-token.ts          # Read existing CLI tokens from OS keychain
│       ├── config.ts                # API URL resolution
│       ├── db/
│       │   ├── index.ts             # DB initialization, auto-migration
│       │   ├── schema/
│       │   │   └── index.ts         # Drizzle schema (credentials tables)
│       │   └── utils.ts             # ID generation (nanoid)
│       └── trpc/routers/
│           ├── claude-code.ts       # Claude Code OAuth flow router
│           ├── claude.ts            # Claude SDK invocation (uses token)
│           └── anthropic-accounts.ts # Multi-account management
│
├── preload/
│   └── index.ts                     # IPC bridge (exposes desktopApi)
│
└── renderer/
    ├── features/
    │   └── onboarding/
    │       ├── billing-method-page.tsx    # Step 1: Choose auth method
    │       └── anthropic-onboarding-page.tsx # Step 2: OAuth flow UI
    ├── components/dialogs/
    │   └── claude-login-modal.tsx    # Re-auth modal for expired tokens
    ├── lib/
    │   └── atoms/
    │       └── index.ts             # billingMethodAtom, anthropicOnboardingCompletedAtom
    └── App.tsx                      # Auth-gated routing
```

### Key Architectural Decisions

| Decision | Rationale |
|----------|-----------|
| **Sandbox proxy instead of direct OAuth** | The app cannot securely perform OAuth without a backend - the sandbox runs Claude CLI which handles the PKCE flow natively |
| **safeStorage for token encryption** | Uses OS-level encryption (macOS Keychain, Windows DPAPI, Linux Secret Service) - tokens never stored in plaintext |
| **Dual storage (legacy + multi-account)** | Backward compatibility with single-account users while supporting account switching |
| **Token in ENV var, not SDK param** | Claude SDK reads `ANTHROPIC_AUTH_TOKEN` / `CLAUDE_CODE_OAUTH_TOKEN` from environment, not constructor |
| **CLI token import disabled** | Access tokens expire ~8h and the app doesn't store the refresh token from CLI - sandbox flow always used instead |

---

## 3. Tech Stack & Dependencies

| Dependency | Version | Purpose | Required |
|-----------|---------|---------|----------|
| `electron` | 33.4.5 | Desktop framework, `safeStorage` API | Yes |
| `better-sqlite3` | * | SQLite database for token storage | Yes |
| `drizzle-orm` | * | ORM for SQLite queries | Yes |
| `@trpc/server` | * | Type-safe IPC communication | Yes |
| `trpc-electron` | * | tRPC adapter for Electron IPC | Yes |
| `@anthropic-ai/claude-agent-sdk` | * | Claude Code SDK (dynamic import) | Yes |
| `zod` | * | Input validation for tRPC procedures | Yes |
| `jotai` | * | UI state atoms (auth state, onboarding) | Yes |
| `react` | 19 | UI framework | Yes |

### System Requirements

- **Electron** with `safeStorage` API (requires OS keychain access)
- **SQLite** database at `{userData}/data/agents.db`
- **Network access** to `21st.dev` API and CodeSandbox URLs
- **Default browser** for OAuth consent page

---

## 4. Data Models & Schemas

### 4.1 SQLite Tables (Drizzle ORM)

#### `claude_code_credentials` (LEGACY - single account)

```typescript
export const claudeCodeCredentials = sqliteTable("claude_code_credentials", {
  id: text("id").primaryKey().default("default"),      // Always "default"
  oauthToken: text("oauth_token").notNull(),            // Encrypted with safeStorage, base64 encoded
  connectedAt: integer("connected_at", { mode: "timestamp" }),
  userId: text("user_id"),                              // Desktop auth user ID
})
```

#### `anthropic_accounts` (NEW - multi-account)

```typescript
export const anthropicAccounts = sqliteTable("anthropic_accounts", {
  id: text("id").primaryKey().$defaultFn(() => createId()),  // nanoid
  email: text("email"),                                       // From OAuth (if available)
  displayName: text("display_name"),                          // User label
  oauthToken: text("oauth_token").notNull(),                  // Encrypted, base64
  connectedAt: integer("connected_at", { mode: "timestamp" }),
  lastUsedAt: integer("last_used_at", { mode: "timestamp" }),
  desktopUserId: text("desktop_user_id"),                     // 21st.dev user ID
})
```

#### `anthropic_settings` (singleton)

```typescript
export const anthropicSettings = sqliteTable("anthropic_settings", {
  id: text("id").primaryKey().default("singleton"),
  activeAccountId: text("active_account_id"),   // References anthropicAccounts.id
  updatedAt: integer("updated_at", { mode: "timestamp" }),
})
```

### 4.2 File-based Auth (21st.dev Desktop Auth)

```typescript
interface AuthData {
  token: string           // JWT access token
  refreshToken: string    // For silent refresh
  expiresAt: string       // ISO date string
  user: {
    id: string
    email: string
    name: string | null
    imageUrl: string | null
    username: string | null
  }
}
```

**Storage location**: `{userData}/auth.dat` (encrypted binary) or `{userData}/auth.dat.json` (plaintext fallback)

### 4.3 OS Keychain Structure (Claude CLI)

```typescript
// macOS: security find-generic-password -s "Claude Code-credentials" -w
// Windows: ~/.claude/.credentials.json
// Linux: secret-tool lookup service "Claude Code" account "credentials"
interface ClaudeCredentials {
  claudeAiOauth?: {
    accessToken: string
    refreshToken?: string
    expiresAt?: number
    scopes?: string[]
  }
}
```

### 4.4 API Contracts

#### Start Auth (Desktop → 21st.dev API)

```
POST /api/auth/claude-code/start
Headers: x-desktop-token: <21st.dev JWT>

Response 200:
{
  "sandboxId": "abc123",
  "sandboxUrl": "https://xyz.csb.app",
  "sessionId": "session_456"
}
```

#### Poll Status (Desktop → Sandbox)

```
GET {sandboxUrl}/api/auth/{sessionId}/status

Response 200 (waiting):
{ "state": "waiting_for_code", "oauthUrl": null }

Response 200 (ready):
{ "state": "has_url", "oauthUrl": "https://console.anthropic.com/oauth/..." }

Response 200 (success):
{ "state": "success", "oauthToken": "sk-ant-oat01-..." }
```

#### Submit Code (Desktop → Sandbox)

```
POST {sandboxUrl}/api/auth/{sessionId}/code
Content-Type: application/json
Body: { "code": "ABC123#DEF456" }

Response 200: {}
```

#### Anthropic Token Refresh

```
POST https://api.anthropic.com/v1/oauth/token
Content-Type: application/x-www-form-urlencoded
Body: grant_type=refresh_token&refresh_token=<token>&client_id=claude-desktop

Response 200:
{
  "access_token": "sk-ant-oat01-...",
  "refresh_token": "...",
  "expires_in": 28800,
  "token_type": "Bearer"
}
```

---

## 5. Implementation Guide

### 5.1 Setup

1. **Database**: Create SQLite database with the three credential tables
2. **safeStorage**: Ensure Electron's `safeStorage.isEncryptionAvailable()` returns true (requires OS keychain)
3. **21st.dev auth**: User must be authenticated with 21st.dev (separate OAuth flow) before starting Claude Code auth
4. **Backend**: Need a server at `api.21st.dev` that can create CodeSandbox instances with Claude CLI

### 5.2 Core Logic

#### Module 1: Token Encryption (`encryptToken` / `decryptToken`)

**Purpose**: Encrypt/decrypt OAuth tokens using OS keychain before SQLite storage.

```
ENCRYPT(token: string) → string:
  IF safeStorage.isEncryptionAvailable():
    encrypted = safeStorage.encryptString(token)  // Returns Buffer
    RETURN encrypted.toBase64()
  ELSE:
    WARN "Encryption not available"
    RETURN base64Encode(token)  // Fallback: base64 only (NOT secure)

DECRYPT(encrypted: string) → string:
  IF safeStorage.isEncryptionAvailable():
    buffer = base64Decode(encrypted)
    RETURN safeStorage.decryptString(buffer)
  ELSE:
    RETURN base64Decode(encrypted).toString("utf-8")
```

**Edge cases**:
- safeStorage may not be available on headless Linux systems
- Base64 fallback is NOT encryption - just encoding

#### Module 2: OAuth Flow (`claudeCodeRouter`)

**Purpose**: Orchestrate the 3-step sandbox OAuth flow.

**Step 1 - Start Auth** (`startAuth` mutation):
```
FUNCTION startAuth():
  token = getDesktopToken()  // 21st.dev JWT
  IF NOT token: THROW "Not authenticated with 21st.dev"

  response = POST "${apiUrl}/api/auth/claude-code/start"
    Headers: { "x-desktop-token": token }

  RETURN { sandboxId, sandboxUrl, sessionId }
```

**Step 2 - Poll for URL** (`pollStatus` query):
```
FUNCTION pollStatus(sandboxUrl, sessionId):
  response = GET "${sandboxUrl}/api/auth/${sessionId}/status"
  RETURN { state, oauthUrl, error }
```

**Step 3 - Submit Code** (`submitCode` mutation):
```
FUNCTION submitCode(sandboxUrl, sessionId, code):
  POST "${sandboxUrl}/api/auth/${sessionId}/code"
    Body: { code }

  // Poll for token (max 10 seconds, 1s interval)
  FOR i = 0..9:
    WAIT 1 second
    status = GET "${sandboxUrl}/api/auth/${sessionId}/status"
    IF status.state == "success" AND status.oauthToken:
      storeOAuthToken(status.oauthToken)
      RETURN { success: true }
    IF status.state == "error":
      THROW status.error

  THROW "Timeout waiting for OAuth token"
```

#### Module 3: Token Storage (`storeOAuthToken`)

**Purpose**: Store encrypted token in both legacy and multi-account tables.

```
FUNCTION storeOAuthToken(oauthToken, setAsActive = true) → accountId:
  encrypted = encryptToken(oauthToken)
  newId = generateNanoId()

  // Multi-account table
  INSERT INTO anthropic_accounts (id, oauthToken, displayName, connectedAt, desktopUserId)
    VALUES (newId, encrypted, "Anthropic Account", NOW(), currentUser.id)

  IF setAsActive:
    UPSERT anthropic_settings SET activeAccountId = newId

  // Legacy table (backward compat)
  DELETE FROM claude_code_credentials WHERE id = "default"
  INSERT INTO claude_code_credentials (id, oauthToken, connectedAt, userId)
    VALUES ("default", encrypted, NOW(), currentUser.id)

  RETURN newId
```

#### Module 4: Token Retrieval (`getClaudeCodeToken`)

**Purpose**: Get decrypted token for SDK invocation, supporting multi-account → legacy fallback.

```
FUNCTION getClaudeCodeToken() → string | null:
  // Try multi-account first
  settings = SELECT * FROM anthropic_settings WHERE id = "singleton"
  IF settings.activeAccountId:
    account = SELECT * FROM anthropic_accounts WHERE id = settings.activeAccountId
    IF account:
      RETURN decryptToken(account.oauthToken)

  // Fallback to legacy
  cred = SELECT * FROM claude_code_credentials WHERE id = "default"
  IF cred.oauthToken:
    RETURN decryptToken(cred.oauthToken)

  RETURN null
```

#### Module 5: Environment Construction (`buildClaudeEnv`)

**Purpose**: Build complete environment for Claude SDK with token injected.

```
FUNCTION buildClaudeEnv(customEnv?, enableTasks?) → Record<string, string>:
  env = {}

  // 1. Load shell environment (spawns interactive login shell on macOS/Linux)
  shellEnv = getClaudeShellEnvironment()
  MERGE env ← shellEnv

  // 2. Overlay process.env (but preserve shell PATH)
  savedPath = env.PATH
  MERGE env ← process.env
  env.PATH = savedPath  // Shell PATH has homebrew, nvm, etc.

  // 3. Strip sensitive keys (OPENAI_API_KEY, CLAUDE_CODE_USE_BEDROCK, etc.)
  // In dev mode, also strip ANTHROPIC_API_KEY to force OAuth
  FOR key IN STRIPPED_KEYS:
    DELETE env[key]

  // 4. Add custom overrides (token, baseUrl)
  IF customEnv:
    MERGE env ← customEnv  // Includes ANTHROPIC_AUTH_TOKEN

  // 5. Mark as SDK entry
  env.CLAUDE_CODE_ENTRYPOINT = "sdk-ts"
  env.CLAUDE_CODE_ENABLE_TASKS = enableTasks ? "true" : "false"

  RETURN env
```

#### Module 6: SDK Invocation (in `claude.ts` subscription handler)

**Purpose**: Pass token to Claude SDK during chat invocation.

```
FUNCTION invokeClaude(message, subChatId, mode, projectPath, ...):
  // Get token
  claudeCodeToken = getClaudeCodeToken()

  // Build custom config
  finalCustomConfig = {
    token: claudeCodeToken,
    baseUrl: customBaseUrl || undefined,
  }

  // Build environment
  claudeEnv = buildClaudeEnv({
    customEnv: {
      ANTHROPIC_AUTH_TOKEN: finalCustomConfig.token,
      ANTHROPIC_BASE_URL: finalCustomConfig.baseUrl,
    },
    enableTasks: true,
  })

  // Add OAuth token to final env (if no existing API config)
  finalEnv = {
    ...claudeEnv,
    ...(claudeCodeToken && !hasExistingApiConfig && {
      CLAUDE_CODE_OAUTH_TOKEN: claudeCodeToken,
    }),
    CLAUDE_CONFIG_DIR: isolatedConfigDir,
  }

  // Invoke SDK
  result = await claudeQuery(message, {
    cwd: projectPath,
    options: {
      maxTurns: 50,
      model: selectedModel,
      permissionMode: mode === "plan" ? "plan" : "default",
      allowedTools: [...],
    },
    executable: getBundledClaudeBinaryPath(),
    pathToClaudeCodeConfig: isolatedConfigDir,
    env: finalEnv,
  })
```

**Key details**:
- Two env vars are set: `ANTHROPIC_AUTH_TOKEN` (via `buildClaudeEnv` customEnv) and `CLAUDE_CODE_OAUTH_TOKEN` (added directly to finalEnv)
- `CLAUDE_CODE_OAUTH_TOKEN` is only set if the user does NOT have an existing `ANTHROPIC_API_KEY` or `ANTHROPIC_BASE_URL` in their shell (respects existing CLI config)
- Each sub-chat gets an isolated config directory: `{userData}/claude-sessions/{subChatId}`

#### Module 7: Existing CLI Token Import (`claude-token.ts`)

**Purpose**: Read Claude OAuth tokens from OS keychain (installed by Claude CLI).

```
FUNCTION getExistingClaudeCredentials() → { accessToken, refreshToken?, expiresAt? } | null:
  // Platform-specific keychain read
  IF macOS:
    result = execSync('security find-generic-password -s "Claude Code-credentials" -w')
    PARSE as JSON → credentials.claudeAiOauth
  ELIF Windows:
    READ ~/.claude/.credentials.json
  ELIF Linux:
    TRY secret-tool lookup service "Claude Code" account "credentials"
    OR FALLBACK: pass show claude-code/credentials

  // Final fallback: ~/.claude/.credentials.json
  RETURN credentials.claudeAiOauth || null
```

**Note**: This import is currently **disabled** in the onboarding UI because access tokens expire in ~8 hours and the app doesn't persist the refresh token from CLI. The sandbox OAuth flow is always used instead.

#### Module 8: Token Refresh (`refreshClaudeToken`)

```
FUNCTION refreshClaudeToken(refreshToken) → { accessToken, refreshToken, expiresAt }:
  response = POST "https://api.anthropic.com/v1/oauth/token"
    Content-Type: application/x-www-form-urlencoded
    Body: grant_type=refresh_token&refresh_token={refreshToken}&client_id=claude-desktop

  RETURN {
    accessToken: response.access_token,
    refreshToken: response.refresh_token || originalRefreshToken,
    expiresAt: Date.now() + response.expires_in * 1000,
  }
```

#### Module 9: Desktop Auth Store (`AuthStore`)

**Purpose**: Encrypted file-based storage for 21st.dev platform tokens.

```
FUNCTION save(data: AuthData):
  jsonData = JSON.stringify(data)
  IF safeStorage.isEncryptionAvailable():
    encrypted = safeStorage.encryptString(jsonData)  // Returns Buffer
    writeFile("{userData}/auth.dat", encrypted)       // Binary file
  ELSE:
    writeFile("{userData}/auth.dat.json", jsonData)   // Plaintext fallback

FUNCTION load() → AuthData | null:
  // Priority: encrypted → plaintext fallback → legacy auth.json
  IF exists("auth.dat") AND safeStorage available:
    encrypted = readFile("auth.dat")
    RETURN JSON.parse(safeStorage.decryptString(encrypted))
  ELIF exists("auth.dat.json"):
    data = readFile("auth.dat.json")
    IF safeStorage available: migrate to auth.dat, delete auth.dat.json
    RETURN JSON.parse(data)
  ELIF exists("auth.json"):  // Legacy
    data = readFile("auth.json")
    migrate to auth.dat, delete auth.json
    RETURN JSON.parse(data)
  RETURN null
```

#### Module 10: Desktop Auth Manager (`AuthManager`)

**Purpose**: Manage 21st.dev auth lifecycle (this is a PREREQUISITE for Claude Code auth).

```
FUNCTION exchangeCode(code) → AuthData:
  response = POST "${apiUrl}/api/auth/desktop/exchange"
    Body: { code, deviceInfo: "21st Desktop {version} ({platform} {arch})" }
  SAVE tokens to AuthStore
  SCHEDULE refresh timer
  RETURN authData

FUNCTION refresh() → boolean:
  response = POST "${apiUrl}/api/auth/desktop/refresh"
    Body: { refreshToken }
  IF 401: logout()
  ELSE: SAVE new tokens, reschedule refresh
  RETURN success

FUNCTION scheduleRefresh():
  expiresAt = authData.expiresAt
  refreshIn = max(0, expiresAt - now - 5 minutes)
  setTimeout(refresh, refreshIn)

FUNCTION startAuthFlow(mainWindow):
  url = "${apiUrl}/auth/desktop?auto=true"
  IF dev: url += "&callback=http://localhost:{AUTH_SERVER_PORT}/auth/callback"
           url += "&protocol=twentyfirst-agents-dev"
  shell.openExternal(url)
```

### 5.3 Integration Points

#### Auth Prerequisites Chain

```
1. User opens app
2. App checks: has 21st.dev token? (AuthStore.isAuthenticated())
   └─ NO → Start 21st.dev OAuth flow (AuthManager.startAuthFlow)
   └─ YES → Continue
3. App checks: billingMethod set?
   └─ NO → Show BillingMethodPage
   └─ YES → Continue
4. If billingMethod == "claude-subscription":
   App checks: anthropicOnboardingCompleted?
   └─ NO → Show AnthropicOnboardingPage (Claude Code OAuth)
   └─ YES → Continue
5. App checks: selectedProject?
   └─ NO → Show SelectRepoPage
   └─ YES → Show main AgentsLayout (chat interface)
```

#### Token Flow During Chat

```
User sends message
  → claude.ts subscription handler
    → getClaudeCodeToken() reads from SQLite + decrypts
    → checkOfflineFallback() verifies connectivity
    → buildClaudeEnv() constructs shell environment
    → ANTHROPIC_AUTH_TOKEN = decrypted token
    → CLAUDE_CODE_OAUTH_TOKEN = decrypted token (if no CLI config)
    → claudeQuery() invokes Claude SDK with env
    → SDK reads CLAUDE_CODE_OAUTH_TOKEN from env
    → SDK authenticates with Anthropic API
```

### 5.4 UI/UX Specification

#### Billing Method Page (Step 1)

**Visual**: Dark background, centered card with 3 radio-style options
- **Claude Pro/Max** (Recommended) - orange icon `#D97757`, selected by default
- **Anthropic API Key** - key icon, muted
- **Custom Model** - gear icon, muted
- Blue "Continue" button at bottom

**States**:
- Default: "Claude Pro/Max" pre-selected with blue checkmark
- Hover: Slight shadow increase on option cards
- Active: Scale 0.99 on press

**Flow**: Setting `billingMethodAtom` to "claude-subscription" routes to Anthropic onboarding.

#### Anthropic Onboarding Page (Step 2)

**Visual**: Dark background, centered layout with dual-icon header (21st logo + Claude Code icon)

**States (AuthFlowState)**:
1. **idle** → Auto-starts auth, shows "Connect" button
2. **starting** → Spinner if user clicked Connect
3. **waiting_url** → Polling for OAuth URL (1.5s interval)
4. **has_url** → Opens browser, shows code input field
5. **submitting** → Spinner in input field
6. **error** → Red error box + "Try Again" button

**Existing Token Detection** (currently disabled):
- If CLI token found in keychain: shows preview `sk-ant-oat01-gbBvCP...PAkwAA`
- Two buttons: "Auth with Anthropic" (start fresh) / "Use existing token" (import)

**Code Input**:
- Monospace, centered text
- Auto-submits when pasted code matches format: >50 chars + contains `#`
- Also supports Enter key to submit
- "Didn't open? Click here" fallback link

**Responsive**: Fixed viewport, no breakpoints (desktop-only Electron app)

---

## 6. Configuration

### Environment Variables

| Variable | Description | Example | Where Set |
|----------|-------------|---------|-----------|
| `ANTHROPIC_AUTH_TOKEN` | OAuth token for Claude API | `sk-ant-oat01-...` | `buildClaudeEnv` customEnv |
| `CLAUDE_CODE_OAUTH_TOKEN` | OAuth token (SDK-specific) | `sk-ant-oat01-...` | Final env in claude.ts |
| `ANTHROPIC_BASE_URL` | Custom API endpoint | `https://api.anthropic.com` | From customConfig |
| `CLAUDE_CODE_ENTRYPOINT` | SDK entry point marker | `sdk-ts` | Always set |
| `CLAUDE_CONFIG_DIR` | Isolated config per sub-chat | `{userData}/claude-sessions/{id}` | Final env |
| `CLAUDE_CODE_ENABLE_TASKS` | Enable task management tools | `true` / `false` | `buildClaudeEnv` |
| `MAIN_VITE_API_URL` | Override 21st.dev API URL (dev only) | `http://localhost:3000` | .env file |

### Stripped Environment Variables

These are removed from the shell environment before SDK invocation to prevent interference:

| Variable | Always Stripped | Dev-Only Stripped |
|----------|----------------|-------------------|
| `OPENAI_API_KEY` | Yes | - |
| `CLAUDE_CODE_USE_BEDROCK` | Yes | - |
| `CLAUDE_CODE_USE_VERTEX` | Yes | - |
| `ANTHROPIC_API_KEY` | - | Yes (forces OAuth in dev) |

---

## 7. Testing Specification

### Critical Test Scenarios

| Scenario | Input | Expected |
|----------|-------|----------|
| Happy path OAuth | Valid subscription | Token encrypted + stored in both tables, onboarding completed |
| Sandbox creation failure | No 21st.dev token | Error: "Not authenticated with 21st.dev" |
| Sandbox timeout | Sandbox never returns URL | Error state after polling repeatedly |
| Invalid auth code | Wrong format code | Code submission error |
| Token exchange timeout | Sandbox never returns token | "Timeout waiting for OAuth token" after 10s |
| safeStorage unavailable | Headless Linux | Token stored as base64 (warn logged) |
| Multi-account switch | Two accounts stored | Active account token used for SDK |
| Legacy fallback | Only `claude_code_credentials` populated | Falls back to legacy table |
| Token decryption failure | Corrupted DB entry | Returns `{ token: null, error: "Failed to decrypt token" }` |
| Existing CLI token (disabled) | Token in macOS Keychain | Currently returns null (feature disabled) |
| Token refresh | Expired Anthropic token | POST to `/v1/oauth/token`, new token returned |
| Disconnect | User clicks disconnect | Active account deleted, falls back to next or null |

---

## 8. Deployment & Infrastructure

### Build Process

- Electron app built with `electron-vite` + `electron-builder`
- Database migrations auto-run on startup via `initDatabase()`
- Claude CLI binary bundled per-platform at `resources/bin/{platform}-{arch}/claude`

### Infrastructure Requirements

- **21st.dev API** at `https://21st.dev` (or override via `MAIN_VITE_API_URL`)
  - Must support `POST /api/auth/claude-code/start` (creates CodeSandbox)
  - Must support `POST /api/auth/desktop/exchange` and `/refresh`
- **CodeSandbox** instances (created on-demand by 21st.dev API)
  - Must expose `/api/auth/{sessionId}/status` and `/api/auth/{sessionId}/code`
- **Anthropic OAuth** at `https://api.anthropic.com/v1/oauth/token` (for token refresh)

---

## 9. Replication Checklist

### Back-End
- [ ] SQLite database with three credential tables (legacy, multi-account, settings)
- [ ] Token encryption using OS keychain (Electron safeStorage / equivalent)
- [ ] tRPC router with startAuth, pollStatus, submitCode, getToken, disconnect procedures
- [ ] Shell environment capture (interactive login shell spawn)
- [ ] Environment variable construction with sensitive key stripping
- [ ] Token injection into SDK environment (`ANTHROPIC_AUTH_TOKEN`, `CLAUDE_CODE_OAUTH_TOKEN`)
- [ ] Platform-specific keychain reading (macOS `security`, Windows `.credentials.json`, Linux `secret-tool`)
- [ ] Token refresh via Anthropic API `/v1/oauth/token`
- [ ] Desktop auth manager with auto-refresh scheduling (5 min before expiry)
- [ ] Encrypted file-based auth store with plaintext migration

### Front-End
- [ ] Billing method selection page (3 options: subscription, API key, custom)
- [ ] Anthropic onboarding page with state machine (idle → starting → waiting_url → has_url → submitting)
- [ ] Auto-start auth on component mount
- [ ] OAuth URL polling (1.5s interval via React Query)
- [ ] Browser open via `shell.openExternal`
- [ ] Code input with auto-submit on valid format (>50 chars + contains `#`)
- [ ] Existing token detection and import (currently disabled)
- [ ] Error state with retry
- [ ] Auth-gated routing (no chat access without completed onboarding)
- [ ] Re-auth modal for expired tokens (`claude-login-modal.tsx`)
- [ ] Jotai atoms for auth state persistence

### Integration
- [ ] 21st.dev API connectivity for sandbox creation
- [ ] Sandbox polling and code submission
- [ ] Claude SDK invocation with token in environment
- [ ] Isolated config directory per sub-chat session
- [ ] Offline fallback to Ollama (when enabled)

### Quality
- [ ] Token never logged in plaintext (only `!!token` or first 10 chars)
- [ ] Graceful degradation when safeStorage unavailable
- [ ] Legacy table backward compatibility
- [ ] Auto-migration from plaintext to encrypted storage
